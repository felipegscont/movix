import { PrismaClient } from '@prisma/client';
import * as fs from 'fs';
import * as path from 'path';

const prisma = new PrismaClient();

/**
 * Script para popular todas as tabelas fiscais (CFOP, CST, CSOSN, NCM, CEST)
 * 
 * Uso:
 * npx ts-node prisma/seeds/seed-fiscal-tables.ts
 */

async function seedCFOP() {
  console.log('üîÑ Populando tabela CFOP...');
  
  const cfopData = JSON.parse(
    fs.readFileSync(path.join(__dirname, 'data/cfop.json'), 'utf-8')
  );

  let count = 0;
  for (const cfop of cfopData.list) {
    await prisma.cfop.upsert({
      where: { codigo: cfop.codigo },
      update: {
        descricao: cfop.descricao,
        tipo: cfop.codigo.startsWith('1') || cfop.codigo.startsWith('2') || cfop.codigo.startsWith('3') 
          ? 'ENTRADA' 
          : 'SAIDA',
      },
      create: {
        codigo: cfop.codigo,
        descricao: cfop.descricao,
        tipo: cfop.codigo.startsWith('1') || cfop.codigo.startsWith('2') || cfop.codigo.startsWith('3') 
          ? 'ENTRADA' 
          : 'SAIDA',
      },
    });
    count++;
  }

  console.log(`‚úÖ ${count} CFOPs inseridos/atualizados`);
}

async function seedCSTICMS() {
  console.log('üîÑ Populando tabela CST ICMS...');
  
  const csts = [
    { codigo: '00', descricao: 'Tributada integralmente' },
    { codigo: '10', descricao: 'Tributada e com cobran√ßa do ICMS por substitui√ß√£o tribut√°ria' },
    { codigo: '20', descricao: 'Com redu√ß√£o de base de c√°lculo' },
    { codigo: '30', descricao: 'Isenta ou n√£o tributada e com cobran√ßa do ICMS por substitui√ß√£o tribut√°ria' },
    { codigo: '40', descricao: 'Isenta' },
    { codigo: '41', descricao: 'N√£o tributada' },
    { codigo: '50', descricao: 'Suspens√£o' },
    { codigo: '51', descricao: 'Diferimento' },
    { codigo: '60', descricao: 'ICMS cobrado anteriormente por substitui√ß√£o tribut√°ria' },
    { codigo: '70', descricao: 'Com redu√ß√£o de base de c√°lculo e cobran√ßa do ICMS por substitui√ß√£o tribut√°ria' },
    { codigo: '90', descricao: 'Outras' },
  ];

  for (const cst of csts) {
    await prisma.cST.upsert({
      where: { codigo_tipo: { codigo: cst.codigo, tipo: 'ICMS' } },
      update: { descricao: cst.descricao },
      create: {
        codigo: cst.codigo,
        descricao: cst.descricao,
        tipo: 'ICMS',
      },
    });
  }

  console.log(`‚úÖ ${csts.length} CSTs ICMS inseridos/atualizados`);
}

async function seedCSOSN() {
  console.log('üîÑ Populando tabela CSOSN...');
  
  const csosns = [
    { codigo: '101', descricao: 'Tributada pelo Simples Nacional com permiss√£o de cr√©dito' },
    { codigo: '102', descricao: 'Tributada pelo Simples Nacional sem permiss√£o de cr√©dito' },
    { codigo: '103', descricao: 'Isen√ß√£o do ICMS no Simples Nacional para faixa de receita bruta' },
    { codigo: '201', descricao: 'Tributada pelo Simples Nacional com permiss√£o de cr√©dito e com cobran√ßa do ICMS por substitui√ß√£o tribut√°ria' },
    { codigo: '202', descricao: 'Tributada pelo Simples Nacional sem permiss√£o de cr√©dito e com cobran√ßa do ICMS por substitui√ß√£o tribut√°ria' },
    { codigo: '203', descricao: 'Isen√ß√£o do ICMS no Simples Nacional para faixa de receita bruta e com cobran√ßa do ICMS por substitui√ß√£o tribut√°ria' },
    { codigo: '300', descricao: 'Imune' },
    { codigo: '400', descricao: 'N√£o tributada pelo Simples Nacional' },
    { codigo: '500', descricao: 'ICMS cobrado anteriormente por substitui√ß√£o tribut√°ria (substitu√≠do) ou por antecipa√ß√£o' },
    { codigo: '900', descricao: 'Outros' },
  ];

  for (const csosn of csosns) {
    await prisma.cSOSN.upsert({
      where: { codigo: csosn.codigo },
      update: { descricao: csosn.descricao },
      create: {
        codigo: csosn.codigo,
        descricao: csosn.descricao,
      },
    });
  }

  console.log(`‚úÖ ${csosns.length} CSOSNs inseridos/atualizados`);
}

async function seedCSTPIS() {
  console.log('üîÑ Populando tabela CST PIS...');
  
  const csts = [
    { codigo: '01', descricao: 'Opera√ß√£o Tribut√°vel com Al√≠quota B√°sica' },
    { codigo: '02', descricao: 'Opera√ß√£o Tribut√°vel com Al√≠quota Diferenciada' },
    { codigo: '03', descricao: 'Opera√ß√£o Tribut√°vel com Al√≠quota por Unidade de Medida de Produto' },
    { codigo: '04', descricao: 'Opera√ß√£o Tribut√°vel Monof√°sica - Revenda a Al√≠quota Zero' },
    { codigo: '05', descricao: 'Opera√ß√£o Tribut√°vel por Substitui√ß√£o Tribut√°ria' },
    { codigo: '06', descricao: 'Opera√ß√£o Tribut√°vel a Al√≠quota Zero' },
    { codigo: '07', descricao: 'Opera√ß√£o Isenta da Contribui√ß√£o' },
    { codigo: '08', descricao: 'Opera√ß√£o sem Incid√™ncia da Contribui√ß√£o' },
    { codigo: '09', descricao: 'Opera√ß√£o com Suspens√£o da Contribui√ß√£o' },
    { codigo: '49', descricao: 'Outras Opera√ß√µes de Sa√≠da' },
    { codigo: '50', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada Exclusivamente a Receita Tributada no Mercado Interno' },
    { codigo: '51', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada Exclusivamente a Receita N√£o Tributada no Mercado Interno' },
    { codigo: '52', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada Exclusivamente a Receita de Exporta√ß√£o' },
    { codigo: '53', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada a Receitas Tributadas e N√£o-Tributadas no Mercado Interno' },
    { codigo: '54', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada a Receitas Tributadas no Mercado Interno e de Exporta√ß√£o' },
    { codigo: '55', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada a Receitas N√£o-Tributadas no Mercado Interno e de Exporta√ß√£o' },
    { codigo: '56', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada a Receitas Tributadas e N√£o-Tributadas no Mercado Interno, e de Exporta√ß√£o' },
    { codigo: '60', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada Exclusivamente a Receita Tributada no Mercado Interno' },
    { codigo: '61', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada Exclusivamente a Receita N√£o-Tributada no Mercado Interno' },
    { codigo: '62', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada Exclusivamente a Receita de Exporta√ß√£o' },
    { codigo: '63', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada a Receitas Tributadas e N√£o-Tributadas no Mercado Interno' },
    { codigo: '64', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada a Receitas Tributadas no Mercado Interno e de Exporta√ß√£o' },
    { codigo: '65', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada a Receitas N√£o-Tributadas no Mercado Interno e de Exporta√ß√£o' },
    { codigo: '66', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada a Receitas Tributadas e N√£o-Tributadas no Mercado Interno, e de Exporta√ß√£o' },
    { codigo: '67', descricao: 'Cr√©dito Presumido - Outras Opera√ß√µes' },
    { codigo: '70', descricao: 'Opera√ß√£o de Aquisi√ß√£o sem Direito a Cr√©dito' },
    { codigo: '71', descricao: 'Opera√ß√£o de Aquisi√ß√£o com Isen√ß√£o' },
    { codigo: '72', descricao: 'Opera√ß√£o de Aquisi√ß√£o com Suspens√£o' },
    { codigo: '73', descricao: 'Opera√ß√£o de Aquisi√ß√£o a Al√≠quota Zero' },
    { codigo: '74', descricao: 'Opera√ß√£o de Aquisi√ß√£o sem Incid√™ncia da Contribui√ß√£o' },
    { codigo: '75', descricao: 'Opera√ß√£o de Aquisi√ß√£o por Substitui√ß√£o Tribut√°ria' },
    { codigo: '98', descricao: 'Outras Opera√ß√µes de Entrada' },
    { codigo: '99', descricao: 'Outras Opera√ß√µes' },
  ];

  for (const cst of csts) {
    await prisma.cST.upsert({
      where: { codigo_tipo: { codigo: cst.codigo, tipo: 'PIS' } },
      update: { descricao: cst.descricao },
      create: {
        codigo: cst.codigo,
        descricao: cst.descricao,
        tipo: 'PIS',
      },
    });
  }

  console.log(`‚úÖ ${csts.length} CSTs PIS inseridos/atualizados`);
}

async function seedCSTCOFINS() {
  console.log('üîÑ Populando tabela CST COFINS...');
  
  // COFINS usa os mesmos c√≥digos do PIS
  const csts = [
    { codigo: '01', descricao: 'Opera√ß√£o Tribut√°vel com Al√≠quota B√°sica' },
    { codigo: '02', descricao: 'Opera√ß√£o Tribut√°vel com Al√≠quota Diferenciada' },
    { codigo: '03', descricao: 'Opera√ß√£o Tribut√°vel com Al√≠quota por Unidade de Medida de Produto' },
    { codigo: '04', descricao: 'Opera√ß√£o Tribut√°vel Monof√°sica - Revenda a Al√≠quota Zero' },
    { codigo: '05', descricao: 'Opera√ß√£o Tribut√°vel por Substitui√ß√£o Tribut√°ria' },
    { codigo: '06', descricao: 'Opera√ß√£o Tribut√°vel a Al√≠quota Zero' },
    { codigo: '07', descricao: 'Opera√ß√£o Isenta da Contribui√ß√£o' },
    { codigo: '08', descricao: 'Opera√ß√£o sem Incid√™ncia da Contribui√ß√£o' },
    { codigo: '09', descricao: 'Opera√ß√£o com Suspens√£o da Contribui√ß√£o' },
    { codigo: '49', descricao: 'Outras Opera√ß√µes de Sa√≠da' },
    { codigo: '50', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada Exclusivamente a Receita Tributada no Mercado Interno' },
    { codigo: '51', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada Exclusivamente a Receita N√£o Tributada no Mercado Interno' },
    { codigo: '52', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada Exclusivamente a Receita de Exporta√ß√£o' },
    { codigo: '53', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada a Receitas Tributadas e N√£o-Tributadas no Mercado Interno' },
    { codigo: '54', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada a Receitas Tributadas no Mercado Interno e de Exporta√ß√£o' },
    { codigo: '55', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada a Receitas N√£o-Tributadas no Mercado Interno e de Exporta√ß√£o' },
    { codigo: '56', descricao: 'Opera√ß√£o com Direito a Cr√©dito - Vinculada a Receitas Tributadas e N√£o-Tributadas no Mercado Interno, e de Exporta√ß√£o' },
    { codigo: '60', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada Exclusivamente a Receita Tributada no Mercado Interno' },
    { codigo: '61', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada Exclusivamente a Receita N√£o-Tributada no Mercado Interno' },
    { codigo: '62', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada Exclusivamente a Receita de Exporta√ß√£o' },
    { codigo: '63', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada a Receitas Tributadas e N√£o-Tributadas no Mercado Interno' },
    { codigo: '64', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada a Receitas Tributadas no Mercado Interno e de Exporta√ß√£o' },
    { codigo: '65', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada a Receitas N√£o-Tributadas no Mercado Interno e de Exporta√ß√£o' },
    { codigo: '66', descricao: 'Cr√©dito Presumido - Opera√ß√£o de Aquisi√ß√£o Vinculada a Receitas Tributadas e N√£o-Tributadas no Mercado Interno, e de Exporta√ß√£o' },
    { codigo: '67', descricao: 'Cr√©dito Presumido - Outras Opera√ß√µes' },
    { codigo: '70', descricao: 'Opera√ß√£o de Aquisi√ß√£o sem Direito a Cr√©dito' },
    { codigo: '71', descricao: 'Opera√ß√£o de Aquisi√ß√£o com Isen√ß√£o' },
    { codigo: '72', descricao: 'Opera√ß√£o de Aquisi√ß√£o com Suspens√£o' },
    { codigo: '73', descricao: 'Opera√ß√£o de Aquisi√ß√£o a Al√≠quota Zero' },
    { codigo: '74', descricao: 'Opera√ß√£o de Aquisi√ß√£o sem Incid√™ncia da Contribui√ß√£o' },
    { codigo: '75', descricao: 'Opera√ß√£o de Aquisi√ß√£o por Substitui√ß√£o Tribut√°ria' },
    { codigo: '98', descricao: 'Outras Opera√ß√µes de Entrada' },
    { codigo: '99', descricao: 'Outras Opera√ß√µes' },
  ];

  for (const cst of csts) {
    await prisma.cST.upsert({
      where: { codigo_tipo: { codigo: cst.codigo, tipo: 'COFINS' } },
      update: { descricao: cst.descricao },
      create: {
        codigo: cst.codigo,
        descricao: cst.descricao,
        tipo: 'COFINS',
      },
    });
  }

  console.log(`‚úÖ ${csts.length} CSTs COFINS inseridos/atualizados`);
}

async function seedCSTIPI() {
  console.log('üîÑ Populando tabela CST IPI...');
  
  const csts = [
    { codigo: '00', descricao: 'Entrada com Recupera√ß√£o de Cr√©dito' },
    { codigo: '01', descricao: 'Entrada Tributada com Al√≠quota Zero' },
    { codigo: '02', descricao: 'Entrada Isenta' },
    { codigo: '03', descricao: 'Entrada N√£o-Tributada' },
    { codigo: '04', descricao: 'Entrada Imune' },
    { codigo: '05', descricao: 'Entrada com Suspens√£o' },
    { codigo: '49', descricao: 'Outras Entradas' },
    { codigo: '50', descricao: 'Sa√≠da Tributada' },
    { codigo: '51', descricao: 'Sa√≠da Tributada com Al√≠quota Zero' },
    { codigo: '52', descricao: 'Sa√≠da Isenta' },
    { codigo: '53', descricao: 'Sa√≠da N√£o-Tributada' },
    { codigo: '54', descricao: 'Sa√≠da Imune' },
    { codigo: '55', descricao: 'Sa√≠da com Suspens√£o' },
    { codigo: '99', descricao: 'Outras Sa√≠das' },
  ];

  for (const cst of csts) {
    await prisma.cST.upsert({
      where: { codigo_tipo: { codigo: cst.codigo, tipo: 'IPI' } },
      update: { descricao: cst.descricao },
      create: {
        codigo: cst.codigo,
        descricao: cst.descricao,
        tipo: 'IPI',
      },
    });
  }

  console.log(`‚úÖ ${csts.length} CSTs IPI inseridos/atualizados`);
}

async function main() {
  console.log('üöÄ Iniciando seed das tabelas fiscais...\n');

  try {
    await seedCFOP();
    await seedCSTICMS();
    await seedCSOSN();
    await seedCSTPIS();
    await seedCSTCOFINS();
    await seedCSTIPI();

    console.log('\n‚úÖ Seed conclu√≠do com sucesso!');
  } catch (error) {
    console.error('‚ùå Erro ao executar seed:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  });

